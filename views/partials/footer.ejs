</main>

<footer>
    <div class="container">
        <p>&copy; 2024 EduShare Connect. All rights reserved.</p>
    </div>
</footer>

<script src="/socket.io/socket.io.js"></script>
<script src="/js/main.js"></script>
</body>

</html>

<% if (typeof user !=='undefined' && user) { %>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check if socket is already defined (to avoid conflicts if main.js defines it)
            // But here we define a local one for notifications
            const notificationSocket = io();
            const currentUserId = '<%= user.id %>';

            // Join user's personal room for notifications
            notificationSocket.emit('join-user', currentUserId);

            // Listen for new message notifications
            notificationSocket.on('message-notification', (data) => {
                console.log('New notification:', data);

                // 1. Update Badge
                const badge = document.getElementById('msg-badge');
                if (badge) {
                    let count = parseInt(badge.innerText) || 0;
                    badge.innerText = count + 1;
                    badge.style.display = 'flex'; // Changed to flex for centering if needed, or inline-block
                    badge.style.justifyContent = 'center';
                    badge.style.alignItems = 'center';
                }

                // 2. Show Toast
                showToast(data);

                // 3. Play Sound (Optional)
                // const audio = new Audio('/sounds/notification.mp3');
                // audio.play().catch(e => console.log('Audio play failed', e));
            });

            function showToast(data) {
                const container = document.getElementById('toast-container');
                if (!container) return;

                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `
                <div style="font-size: 24px; color: #4CAF50;">
                    <i class="fas fa-comment-dots"></i>
                </div>
                <div class="toast-content">
                    <strong>${data.sender}</strong>
                    <p>${data.message.substring(0, 40)}${data.message.length > 40 ? '...' : ''}</p>
                </div>
            `;

                // Click to go to chat
                toast.onclick = () => window.location.href = '/communication';

                container.appendChild(toast);

                // Remove after 5 seconds
                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.5s forwards';
                    setTimeout(() => toast.remove(), 500);
                }, 5000);
            }
        });
    </script>
    <% } %>