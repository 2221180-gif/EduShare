</main>

</main>

<footer>
    <div class="container">
        <p>&copy; 2024 EduShare Connect. All rights reserved.</p>
    </div>
</footer>

<script src="/socket.io/socket.io.js"></script>
<script src="/js/main.js"></script>

<% if (typeof user !=='undefined' && user) { %>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Notification System Loaded');

            // Notification Socket
            const notificationSocket = io();
            const currentUserId = '<%= user.id %>';

            // Join user's personal room
            notificationSocket.emit('join-user', currentUserId);
            console.log('Joined notification room for user:', currentUserId);

            // Listen for new message notifications
            notificationSocket.on('message-notification', (data) => {
                console.log('RECEIVED NOTIFICATION:', data);
                updateBadge();
                showToast(data);
            });

            // Helper to update badge
            function updateBadge() {
                const badge = document.getElementById('msg-badge');
                if (badge) {
                    let count = parseInt(badge.innerText) || 0;
                    badge.innerText = count + 1;
                    badge.style.display = 'flex';
                    badge.style.justifyContent = 'center';
                    badge.style.alignItems = 'center';
                }
            }

            // Helper to show toast
            function showToast(data) {
                const container = document.getElementById('toast-container');
                if (!container) return;

                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `
                <div style="font-size: 24px; color: #4CAF50;">
                    <i class="fas fa-comment-dots"></i>
                </div>
                <div class="toast-content">
                    <strong>${data.sender}</strong>
                    <p>${data.message.substring(0, 40)}${data.message.length > 40 ? '...' : ''}</p>
                </div>
            `;

                toast.onclick = () => window.location.href = '/communication';
                container.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.5s forwards';
                    setTimeout(() => toast.remove(), 500);
                }, 5000);
            }

            // --- DEBUGGING TOOL (Remove later) ---
            // Expose function to window so user can test it
            window.testNotification = function () {
                console.log('Testing notification...');
                updateBadge();
                showToast({
                    sender: 'Test System',
                    message: 'This is a test notification to prove the UI works!'
                });
            };
        });
    </script>
    <% } %>
        </body>

        </html>